"use strict";(()=>{var E=["q.utoronto.ca","acorn.utoronto.ca","portal.engineering.utoronto.ca","engineering.utoronto.ca","library.utoronto.ca","uoft.me","future.utoronto.ca","registrar.utoronto.ca","studentlife.utoronto.ca","utm.utoronto.ca","docs.google.com","drive.google.com","classroom.google.com","meet.google.com","calendar.google.com","notion.so","evernote.com","onenote.com","todoist.com","trello.com","github.com","gitlab.com","bitbucket.org","stackoverflow.com","stackoverflowteams.com","leetcode.com","hackerrank.com","codeforces.com","codewars.com","kaggle.com","w3schools.com","developer.mozilla.org","geeksforgeeks.org","cplusplus.com","python.org","khanacademy.org","coursera.org","edx.org","udemy.com","brilliant.org","wolframalpha.com","desmos.com","overleaf.com","grammarly.com","deepdyve.com","scholar.google.com","jstor.org","ieeexplore.ieee.org","sciencedirect.com","researchgate.net"],_=["youtube.com","tiktok.com","instagram.com","facebook.com","x.com","snapchat.com","reddit.com","pinterest.com","tumblr.com","discord.com","netflix.com","primevideo.com","disneyplus.com","hulu.com","crunchyroll.com","twitch.tv","spotify.com","soundcloud.com","deezer.com","applemusic.com","roblox.com","store.steampowered.com","epicgames.com","playstation.com","xbox.com","9gag.com","boredpanda.com","buzzfeed.com","thechive.com","ifunny.co","amazon.com","ebay.com","aliexpress.com","shein.com","walmart.com","etsy.com","bestbuy.com","costco.com","ikea.com","homedepot.com","onlyfans.com","patreon.com","kick.com","yikyak.com","omegle.com","tripadvisor.com","booking.com","airbnb.com","expedia.com","ubereats.com"];function D(o){if(!o||typeof o!="string")return"";let t=o.toLowerCase().trim();return t=t.replace(/^www\./,""),t}function g(o){let t=D(o);return t?E.includes(t)?"productive":(_.includes(t),"unproductive"):"unproductive"}var P="http://localhost:3000",h={START_SESSION:"/sessions/start",UPLOAD_ACTIVITY:"/sessions/activity",END_SESSION:"/sessions/end"};function u(o){return`${P}${o}`}async function I(o,t){if(!o)return"unproductive";let e=o.toLowerCase().trim();if(t)try{let n=`${u("/domains/classification")}?domain=${encodeURIComponent(e)}`,i=await fetch(n,{headers:{Authorization:`Bearer ${t}`}});if(i.ok){let r=await i.json();if(r.classification&&(r.classification==="productive"||r.classification==="unproductive"))return r.classification}}catch(n){console.warn("Failed to get domain classification from API, using master list:",n)}let s=g(e);return s?(console.log(`[classifyDomainWithOverrides] Master list classification for ${e}: ${s}`),s):(console.log(`[classifyDomainWithOverrides] No classification found for ${e}, defaulting to unproductive`),"unproductive")}function v(o){if(!o||typeof o!="string")return null;try{if(o.startsWith("chrome://")||o.startsWith("chrome-extension://")||o.startsWith("edge://")||o.startsWith("about:"))return null;let s=new URL(o).hostname.replace(/^www\./,"");return s.toLowerCase().includes("q.utoronto.ca")&&console.log("[extractDomain] \u{1F50D} Extracted domain from URL:",o,"\u2192",s),s}catch(t){return console.warn("Failed to extract domain from URL:",o,t),null}}function k(o){return o?!["chrome:","chrome-extension:","edge:","about:"].some(e=>o.startsWith(e)):!1}function a(){return Date.now()}function y(o){let e=a()-o;return Math.floor(e/1e3)}function T(o,t){let s=(t||a())-o;return Math.floor(s/1e3)}async function C(o){let t=u(h.START_SESSION);try{let e=await fetch(t,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${o}`},body:JSON.stringify({authToken:o})});if(!e.ok){let n=await e.text();throw new Error(`Failed to start session: ${e.status} ${n}`)}return{sessionId:(await e.json()).sessionId}}catch(e){throw console.error("Error starting session:",e),e}}async function f(o,t,e){let s=u(h.UPLOAD_ACTIVITY);try{let n=await fetch(s,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:JSON.stringify({sessionId:o,segments:t})});if(!n.ok){let i=await n.text();throw new Error(`Failed to upload activity: ${n.status} ${i}`)}}catch(n){console.error("Error uploading activity:",n)}}async function A(o,t,e){let s=u(h.END_SESSION);try{let n=new Date(t.sessionStartTimestamp).toISOString(),i=t.sessionEndTimestamp?new Date(t.sessionEndTimestamp).toISOString():new Date().toISOString(),r=t.segments.map(c=>({start:new Date(c.start).toISOString(),end:c.end?new Date(c.end).toISOString():void 0,domain:c.domain,productive:c.productive,lockedIn:c.lockedIn,reason:c.reason||null})),d={sessionId:t.sessionId,sessionStartTimestamp:n,sessionEndTimestamp:i,totalSessionSeconds:t.totalSessionSeconds,lockedInSeconds:t.lockedInSeconds,nonLockSeconds:t.nonLockSeconds,focusRate:t.focusRate,idleBeyond2minSeconds:t.idleBeyond2minSeconds,tabSwitchCount:t.tabSwitchCount,lockBreakCount:t.lockBreakCount,segments:r,fileIds:t.fileIds||[]};console.log("Sending endSession request to:",s),console.log("Payload:",JSON.stringify(d,null,2));let l=await fetch(s,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:JSON.stringify(d)});if(!l.ok){let c=await l.text();throw console.error("endSession API error:",{status:l.status,statusText:l.statusText,error:c}),new Error(`Failed to end session: ${l.status} ${c}`)}let p=await l.json();console.log("endSession API success:",p)}catch(n){throw console.error("Error ending session:",n),n}}var w=()=>({sessionState:"noSession",currentTabId:null,currentUrl:null,currentDomain:null,domainClassification:"unproductive",lastActivityTimestamp:a(),currentIdleSeconds:0,lastCheckStatus:"none",sessionId:null,sessionStartTimestamp:0,activitySegments:[],currentSegment:null,lockedInSeconds:0,nonLockSeconds:0,idleBeyond2minSeconds:0,tabSwitchCount:0,lockBreakCount:0,cachedAuthToken:null,finishedSessionMetrics:null,randomCheckAlarmName:null,randomCheckNotificationId:null,uploadIntervalId:null});var S=class{constructor(){this.state=w();this.idleIntervalId=null;this.saveIntervalId=null;this.flushIntervalId=null;this.handleTabActivated=t=>{this.state.currentTabId=t.tabId,this.updateCurrentTab()};this.handleTabUpdated=(t,e,s)=>{s.id===this.state.currentTabId&&e.status==="complete"&&s.url&&this.updateCurrentTab()};this.handleIdleStateChange=t=>{t==="active"?(this.state.lastActivityTimestamp=a(),this.state.currentIdleSeconds=0,this.state.lastCheckStatus="none",this.state.sessionState!=="noSession"&&this.checkAndHandleStateTransition()):this.updateIdleState()};this.handleNotificationButtonClicked=(t,e)=>{t===this.state.randomCheckNotificationId&&(chrome.notifications.clear(t),this.state.randomCheckNotificationId=null,e===0?this.state.lastCheckStatus="passed":(this.state.lastCheckStatus="failed",this.closeCurrentSegment(),this.checkAndHandleStateTransition(),this.createActivitySegment()),this.state.sessionState==="sessionActive_lockedIn"&&this.scheduleRandomCheck())};chrome?.notifications?.onButtonClicked&&chrome.notifications.onButtonClicked.addListener(this.handleNotificationButtonClicked)}async initialize(){console.log("[BackgroundController] Initializing service worker"),await this.restoreSessionState(),await this.restoreFinishedSession(),chrome.tabs.onActivated.addListener(this.handleTabActivated),chrome.tabs.onUpdated.addListener(this.handleTabUpdated),chrome.idle.onStateChanged.addListener(this.handleIdleStateChange),chrome.runtime.onMessage.addListener((t,e,s)=>(this.processPopupMessage(t,t).then(s).catch(n=>{let i=n instanceof Error?n.message:"Unknown error";s({type:"ERROR",message:i})}),!0)),chrome.runtime.onMessageExternal&&chrome.runtime.onMessageExternal.addListener((t,e,s)=>(this.handleExternalMessage(t).then(s).catch(n=>{let i=n instanceof Error?n.message:"Unknown error";s({success:!1,message:i})}),!0)),chrome.alarms&&chrome.alarms.onAlarm.addListener(t=>{t.name.startsWith("randomCheck_")&&this.handleRandomCheck().catch(e=>{console.error("[BackgroundController] Random check failed",e)})}),this.idleIntervalId=setInterval(()=>{this.state.sessionState!=="noSession"&&(this.updateIdleState(),this.checkAndHandleStateTransition())},1e4),this.saveIntervalId=setInterval(async()=>{this.state.sessionState!=="noSession"&&await this.saveSessionState()},3e4),this.flushIntervalId=setInterval(async()=>{await this.flushPendingUploadQueue()},3e5),await this.updateCurrentTab()}async processPopupMessage(t,e){switch(t.type){case"GET_STATE":return{type:"STATE_UPDATE",state:await this.buildPopupState()};case"START_SESSION":return await this.startSession(),{type:"STATE_UPDATE",state:await this.buildPopupState()};case"FINISH_SESSION":return await this.finishSession(),this.state.finishedSessionMetrics?{type:"FINISHED_SESSION",metrics:this.state.finishedSessionMetrics}:{type:"STATE_UPDATE",state:await this.buildPopupState()};case"GET_FINISHED_SESSION":return await this.restoreFinishedSession(),this.state.finishedSessionMetrics?{type:"FINISHED_SESSION",metrics:this.state.finishedSessionMetrics}:{type:"ERROR",message:"No finished session found"};case"UPLOAD_FINISHED_SESSION":return await this.uploadFinishedSession(e?.fileIds??[]),{type:"STATE_UPDATE",state:await this.buildPopupState()};case"DISCARD_FINISHED_SESSION":return await this.discardFinishedSession(),{type:"STATE_UPDATE",state:await this.buildPopupState()};default:return{type:"ERROR",message:"Unknown message type"}}}async handleExternalMessage(t){return t?.type==="ANCHOR_CONNECT"&&t.authToken?(await chrome.storage.sync.set({authToken:t.authToken,userId:t.userId||null}),this.state.cachedAuthToken=t.authToken,this.state.currentDomain&&await this.reclassifyCurrentDomain(),{success:!0,message:"Extension connected successfully"}):{success:!1,message:"Unknown message type"}}async startSession(){if(this.state.sessionState!=="noSession")return;let t=await this.getAuthToken(),e;if(t)try{e=(await C(t)).sessionId}catch(s){console.warn("[BackgroundController] startSession API failed, using local session ID",s),e=`local_${Date.now()}`}else console.warn("[BackgroundController] No auth token. Using local session ID."),e=`local_${Date.now()}`;this.state.sessionId=e,this.state.sessionStartTimestamp=a(),this.state.sessionState="sessionActive_lockedIn",this.state.lastActivityTimestamp=a(),this.state.currentIdleSeconds=0,this.state.lastCheckStatus="none",this.state.activitySegments=[],this.state.currentSegment=null,this.state.lockedInSeconds=0,this.state.nonLockSeconds=0,this.state.idleBeyond2minSeconds=0,this.state.tabSwitchCount=0,this.state.lockBreakCount=0,await this.updateCurrentTab(),this.createActivitySegment(),this.scheduleRandomCheck(),this.startPeriodicUploads(),await this.saveSessionState()}async finishSession(){if(this.state.sessionState==="noSession"||!this.state.sessionId)return;this.closeCurrentSegment(),this.state.randomCheckAlarmName&&chrome.alarms&&(chrome.alarms.clear(this.state.randomCheckAlarmName),this.state.randomCheckAlarmName=null),this.state.uploadIntervalId!==null&&(clearInterval(this.state.uploadIntervalId),this.state.uploadIntervalId=null),this.recalculateMetrics();let t=a(),e=this.state.sessionStartTimestamp>0?Math.floor((t-this.state.sessionStartTimestamp)/1e3):0,s=e>0?this.state.lockedInSeconds/e:0,n={sessionId:this.state.sessionId,sessionStartTimestamp:this.state.sessionStartTimestamp,sessionEndTimestamp:t,totalSessionSeconds:e,lockedInSeconds:this.state.lockedInSeconds,nonLockSeconds:this.state.nonLockSeconds,focusRate:s,idleBeyond2minSeconds:this.state.idleBeyond2minSeconds,tabSwitchCount:this.state.tabSwitchCount,lockBreakCount:this.state.lockBreakCount,segments:this.state.activitySegments};this.state.finishedSessionMetrics=n,await chrome.storage.local.set({finishedSession:n}),this.state.sessionId=null,this.state.sessionStartTimestamp=0,this.state.sessionState="noSession",this.state.activitySegments=[],this.state.currentSegment=null,this.state.lockedInSeconds=0,this.state.nonLockSeconds=0,this.state.idleBeyond2minSeconds=0,this.state.tabSwitchCount=0,this.state.lockBreakCount=0,this.state.lastCheckStatus="none",await chrome.storage.local.remove(["sessionState"])}async uploadFinishedSession(t){if(!this.state.finishedSessionMetrics)throw new Error("No finished session to upload");let e=await this.getAuthToken();if(!e)throw new Error("No auth token. Please connect your account first.");let s={...this.state.finishedSessionMetrics,fileIds:t};await A(s.sessionId,s,e),this.state.finishedSessionMetrics=null,await chrome.storage.local.remove(["finishedSession"])}async discardFinishedSession(){this.state.finishedSessionMetrics=null,await chrome.storage.local.remove(["finishedSession"])}async updateCurrentTab(){try{let t=await chrome.tabs.query({active:!0,currentWindow:!0});if(t.length===0||!t[0].id)return;let e=t[0];if(this.state.currentTabId=e.id,this.state.currentUrl=e.url||null,this.state.currentUrl&&k(this.state.currentUrl)){let s=v(this.state.currentUrl),n=this.state.currentDomain;this.state.currentDomain=s,await this.reclassifyCurrentDomain(),n!==s&&n!==null&&this.state.sessionState!=="noSession"?(this.state.tabSwitchCount++,this.closeCurrentSegment(),this.checkAndHandleStateTransition(),this.createActivitySegment()):this.checkAndHandleStateTransition()}else this.state.currentDomain=null,this.state.domainClassification="unproductive",this.checkAndHandleStateTransition()}catch(t){console.error("[BackgroundController] Failed to update current tab",t)}}async reclassifyCurrentDomain(){if(!this.state.currentDomain){this.state.domainClassification="unproductive";return}if(!this.state.cachedAuthToken){let e=await chrome.storage.sync.get(["authToken"]);this.state.cachedAuthToken=e.authToken||null}let t=await I(this.state.currentDomain,this.state.cachedAuthToken);this.state.domainClassification=t}updateIdleState(){this.state.currentIdleSeconds=y(this.state.lastActivityTimestamp);let t=this.state.currentIdleSeconds<120;this.checkAndHandleStateTransition();let e=this.state.currentIdleSeconds<120;t!==e&&this.state.sessionState!=="noSession"&&(this.closeCurrentSegment(),this.createActivitySegment())}scheduleRandomCheck(){if(this.state.sessionState!=="sessionActive_lockedIn")return;this.state.randomCheckAlarmName&&chrome.alarms&&chrome.alarms.clear(this.state.randomCheckAlarmName);let t=Math.floor(Math.random()*901)+900;this.state.randomCheckAlarmName=`randomCheck_${Date.now()}`,chrome.alarms&&chrome.alarms.create(this.state.randomCheckAlarmName,{delayInMinutes:t/60})}async handleRandomCheck(){if(this.state.sessionState!=="sessionActive_lockedIn")return;let t=await chrome.notifications.create({type:"basic",title:"Focus Check",message:"Are you still focused? Click to confirm.",buttons:[{title:"Yes, I'm focused"},{title:"No, I'm distracted"}],requireInteraction:!0});this.state.randomCheckNotificationId=t;let e=25,s=setInterval(()=>{e-=1,e<=0&&(clearInterval(s),this.handleCheckTimeout())},1e3)}async handleCheckTimeout(){this.state.randomCheckNotificationId&&(chrome.notifications.clear(this.state.randomCheckNotificationId),this.state.randomCheckNotificationId=null),this.state.lastCheckStatus="failed",this.closeCurrentSegment(),this.checkAndHandleStateTransition(),this.createActivitySegment()}createActivitySegment(){if(this.state.sessionState==="noSession")return;let t=this.state.sessionState==="sessionActive_lockedIn",e;t||(this.state.domainClassification==="unproductive"?e="unproductive_domain":this.state.currentIdleSeconds>=120?e="idle_beyond_2m":this.state.lastCheckStatus==="failed"?e="failed_check":e="other"),this.state.currentSegment={start:a(),domain:this.state.currentDomain,productive:this.state.domainClassification==="productive",lockedIn:t,reason:e},this.state.activitySegments.push(this.state.currentSegment)}closeCurrentSegment(){this.state.currentSegment&&(this.state.currentSegment.end=a(),this.state.currentSegment=null)}recalculateMetrics(){this.state.lockedInSeconds=0,this.state.nonLockSeconds=0,this.state.idleBeyond2minSeconds=0;let t=[...this.state.activitySegments];this.state.currentSegment&&t.push({...this.state.currentSegment,end:a()}),t.forEach(e=>{if(!e.end)return;let s=T(e.start,e.end);e.lockedIn?this.state.lockedInSeconds+=s:(this.state.nonLockSeconds+=s,e.reason==="idle_beyond_2m"&&(this.state.idleBeyond2minSeconds+=s))})}computeNextSessionState(){return this.state.sessionState==="noSession"||!this.state.sessionId?"noSession":this.state.domainClassification==="productive"&&this.state.currentIdleSeconds<120&&this.state.lastCheckStatus!=="failed"?"sessionActive_lockedIn":"sessionActive_notLockedIn"}checkAndHandleStateTransition(){let t=this.computeNextSessionState();if(t===this.state.sessionState)return;let e=this.state.sessionState;this.state.sessionState=t,e==="sessionActive_lockedIn"&&t==="sessionActive_notLockedIn"&&(this.state.lockBreakCount+=1),this.closeCurrentSegment(),this.createActivitySegment()}async uploadActivitySegments(){if(!this.state.sessionId||this.state.activitySegments.length===0)return;let t=await this.getAuthToken();if(!t)return;let e=this.state.activitySegments.filter(s=>s.end!==void 0);if(e.length!==0)try{await f(this.state.sessionId,e,t),await this.removeFromPendingQueue(this.state.sessionId,e)}catch(s){console.error("[BackgroundController] Failed to upload activity",s),await this.addToPendingQueue(this.state.sessionId,e)}}startPeriodicUploads(){this.state.uploadIntervalId!==null&&clearInterval(this.state.uploadIntervalId),this.state.uploadIntervalId=setInterval(()=>{this.uploadActivitySegments()},3e5)}async addToPendingQueue(t,e){let n=(await chrome.storage.local.get(["pendingUploads"])).pendingUploads||[];n.push({sessionId:t,segments:e,timestamp:a()}),await chrome.storage.local.set({pendingUploads:n})}async removeFromPendingQueue(t,e){let n=(await chrome.storage.local.get(["pendingUploads"])).pendingUploads||[],i=new Set(e.map(d=>d.start)),r=n.filter(d=>d.sessionId!==t?!0:d.segments.filter(p=>!i.has(p.start)).length>0);await chrome.storage.local.set({pendingUploads:r})}async flushPendingUploadQueue(){let e=(await chrome.storage.local.get(["pendingUploads"])).pendingUploads||[];if(e.length===0)return;let s=await this.getAuthToken();if(!s)return;let n=[];for(let i of e)try{await f(i.sessionId,i.segments,s)}catch(r){console.error("[BackgroundController] Failed to flush pending upload",r),n.push(i)}await chrome.storage.local.set({pendingUploads:n})}async saveSessionState(){let t={hasActiveSession:this.state.sessionState!=="noSession",sessionId:this.state.sessionId??void 0,sessionStartTimestamp:this.state.sessionStartTimestamp??void 0,metrics:{totalSessionSeconds:0,lockedInSeconds:this.state.lockedInSeconds,nonLockSeconds:this.state.nonLockSeconds,idleBeyond2minSeconds:this.state.idleBeyond2minSeconds,tabSwitchCount:this.state.tabSwitchCount,lockBreakCount:this.state.lockBreakCount},sessionState:this.state.sessionState,currentSegment:this.state.currentSegment,activitySegments:this.state.activitySegments,lastActivityTimestamp:this.state.lastActivityTimestamp};await chrome.storage.local.set({sessionState:t})}async restoreSessionState(){let e=(await chrome.storage.local.get(["sessionState"])).sessionState;!e||!e.hasActiveSession||!e.sessionId||(this.state.sessionId=e.sessionId,this.state.sessionStartTimestamp=e.sessionStartTimestamp||a(),this.state.sessionState=e.sessionState||"noSession",this.state.lastActivityTimestamp=e.lastActivityTimestamp||a(),this.state.activitySegments=e.activitySegments||[],this.state.currentSegment=e.currentSegment||null,e.metrics&&(this.state.lockedInSeconds=e.metrics.lockedInSeconds||0,this.state.nonLockSeconds=e.metrics.nonLockSeconds||0,this.state.idleBeyond2minSeconds=e.metrics.idleBeyond2minSeconds||0,this.state.tabSwitchCount=e.metrics.tabSwitchCount||0,this.state.lockBreakCount=e.metrics.lockBreakCount||0),await this.updateCurrentTab(),this.updateIdleState(),this.state.sessionState!=="noSession"&&this.startPeriodicUploads(),await this.flushPendingUploadQueue())}async restoreFinishedSession(){if(this.state.finishedSessionMetrics)return;let t=await chrome.storage.local.get(["finishedSession"]);t.finishedSession&&(this.state.finishedSessionMetrics=t.finishedSession)}async buildPopupState(){let t=a(),e=this.state.sessionStartTimestamp>0?Math.floor((t-this.state.sessionStartTimestamp)/1e3):0;this.recalculateMetrics();let s=e>0?e:0,n=s>0?this.state.lockedInSeconds/s:0,r=await chrome.storage.sync.get(["authToken"]),d=!!r.authToken;return r.authToken&&(this.state.cachedAuthToken=r.authToken),{hasActiveSession:this.state.sessionState!=="noSession",sessionState:this.state.sessionState,totalSessionSeconds:s,lockedInSeconds:this.state.lockedInSeconds,focusRate:n,currentDomain:this.state.currentDomain,isProductiveDomain:this.state.currentDomain?this.state.domainClassification==="productive":null,tabSwitchCount:this.state.tabSwitchCount,idleBeyond2minSeconds:this.state.idleBeyond2minSeconds,lockBreakCount:this.state.lockBreakCount,isConnected:d}}async getAuthToken(){if(this.state.cachedAuthToken)return this.state.cachedAuthToken;let t=await chrome.storage.sync.get(["authToken"]);return this.state.cachedAuthToken=t.authToken||null,this.state.cachedAuthToken}};var R=new S;R.initialize().catch(o=>{console.error("[BackgroundController] Failed to initialize",o)});})();
